<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>e+solutions Pricing Calculator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: linear-gradient(180deg, #fffdf5 0%, #fff5dd 100%);
      --card: #ffffff;
      --shadow: 0 16px 38px rgba(34, 33, 51, 0.08);
      --border: #f3d29d;
      --accent: #ff9f1c;
      --accent-2: #ffb703;
      --text: #1b1f24;
      --muted: #5f6b7a;
      --success: #199b61;
      --error: #c33f3f;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: "Inter", system-ui, -apple-system, Segoe UI, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
    }
    main {
      max-width: 1100px;
      margin: 0 auto;
      padding: 32px 16px 60px;
      display: grid;
      gap: 24px;
    }
    @media (min-width: 980px) {
      main { grid-template-columns: 1.05fr 0.95fr; }
    }
    section.card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 18px;
      box-shadow: var(--shadow);
      padding: 24px;
    }
    h1, h2, h3 { margin: 0 0 12px; }
    p { margin: 0 0 12px; }
    .badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 999px;
      background: #fff4d6;
      border: 1px solid var(--border);
      color: #704c04;
      font-size: 12px;
      font-weight: 600;
    }
    form .grid {
      display: grid;
      gap: 16px;
    }
    @media (min-width: 720px) {
      form .grid { grid-template-columns: repeat(2, minmax(0, 1fr)); }
    }
    .field {
      display: flex;
      flex-direction: column;
      gap: 8px;
      background: #fffdf6;
      border: 1px solid #ffe4b5;
      border-radius: 14px;
      padding: 14px;
    }
    label {
      font-size: 13px;
      color: var(--muted);
      font-weight: 600;
    }
    input, select {
      width: 100%;
      border: 1px solid #ffc46b;
      border-radius: 10px;
      padding: 11px 12px;
      font-size: 15px;
      font-weight: 500;
      color: var(--text);
      background: #ffffff;
      outline: none;
      transition: border-color .18s ease, box-shadow .18s ease;
    }
    input:focus, select:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 6px rgba(255, 183, 3, 0.3);
    }
    .actions {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-top: 18px;
    }
    button {
      border: none;
      border-radius: 12px;
      padding: 12px 18px;
      font-size: 15px;
      font-weight: 700;
      cursor: pointer;
      transition: transform .18s ease, box-shadow .18s ease;
    }
    button.primary {
      background: linear-gradient(180deg, var(--accent-2), var(--accent));
      color: #1f1400;
      box-shadow: 0 14px 30px rgba(255, 159, 28, 0.35);
    }
    button.primary:not(:disabled):hover {
      transform: translateY(-1px);
      box-shadow: 0 14px 34px rgba(255, 159, 28, 0.45);
    }
    button.secondary {
      background: #fff9ed;
      border: 1px solid #ffcf75;
      color: #6c4a03;
    }
    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    .status {
      min-height: 20px;
      font-size: 13px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .status.ok { color: var(--success); }
    .status.err { color: var(--error); }
    .quote-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
      margin-bottom: 12px;
    }
    .quote-summary {
      display: grid;
      gap: 12px;
    }
    .item {
      display: flex;
      justify-content: space-between;
      gap: 12px;
      border: 1px solid #ffe1a6;
      background: #fffdf3;
      padding: 12px 14px;
      border-radius: 12px;
      font-size: 14px;
      font-weight: 600;
    }
    .item.highlight {
      background: #fff6d6;
      border-color: #ffcc55;
    }
    .item .value {
      font-weight: 800;
      letter-spacing: 0.2px;
    }
    .note {
      font-size: 12px;
      color: #6b7382;
      margin-top: 10px;
    }
    .chart-wrap {
      margin-top: 16px;
      padding: 16px;
      border: 1px solid #ffe1a6;
      border-radius: 16px;
      background: #fffdf2;
    }
    canvas {
      width: 100%;
      max-width: 500px;
      display: block;
      margin: 0 auto;
    }
    .legend {
      display: flex;
      flex-wrap: wrap;
      gap: 10px 16px;
      justify-content: center;
      margin-top: 12px;
      font-size: 13px;
      color: #556070;
    }
    .chip {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid #ffd166;
      background: #fff7e1;
    }
    .chip span {
      display: inline-block;
      width: 12px;
      height: 12px;
      border-radius: 3px;
    }
  </style>
</head>
<body>
  <main>
    <section class="card">
      <h1>e+solutions Pricing Calculator</h1>
      <p>Submit onceâ€”this generates a PDF, uploads it through Hookdeck, and saves everything to your Google Sheet.</p>
      <span class="badge" id="endpointBadge">Endpoint ready</span>
      <form id="quoteForm" novalidate>
        <div class="grid">
          <div class="field">
            <label for="customerName">Customer name</label>
            <input id="customerName" name="customerName" type="text" placeholder="Full name" autocomplete="name" required />
          </div>
          <div class="field">
            <label for="companyName">Company</label>
            <input id="companyName" name="companyName" type="text" placeholder="Company Ltd." autocomplete="organization" required />
          </div>
          <div class="field">
            <label for="customerEmail">Customer email</label>
            <input id="customerEmail" name="customerEmail" type="email" placeholder="customer@example.com" autocomplete="email" required />
          </div>
          <div class="field">
            <label for="storageCbm">Storage (CBM)</label>
            <select id="storageCbm" name="storageCbm" required></select>
          </div>
          <div class="field">
            <label for="inboundPieces">Monthly inbound pieces</label>
            <input id="inboundPieces" name="inboundPieces" type="number" min="1" step="1" value="100" required />
          </div>
          <div class="field">
            <label for="monthlyOrders">Monthly orders (outbound)</label>
            <input id="monthlyOrders" name="monthlyOrders" type="number" min="1" step="1" value="100" required />
            <small id="ordersHint" class="note"></small>
          </div>
          <div class="field">
            <label for="avgPieces">Average pieces per order</label>
            <input id="avgPieces" name="avgPieces" type="number" min="1" step="1" value="2" required />
          </div>
          <div class="field">
            <label for="hktv">HKTVmall management?</label>
            <select id="hktv" name="hktv">
              <option value="no" selected>No</option>
              <option value="yes">Yes</option>
            </select>
          </div>
          <div class="field">
            <label for="integration">System integration?</label>
            <select id="integration" name="integration">
              <option value="no" selected>No</option>
              <option value="yes">Yes</option>
            </select>
          </div>
        </div>
        <div class="actions">
          <button type="submit" class="primary" id="submitBtn">Submit &amp; Save</button>
          <button type="button" class="secondary" id="downloadBtn" disabled>Download PDF</button>
          <button type="button" class="secondary" id="resetBtn">Reset</button>
        </div>
        <div class="status" id="status"></div>
      </form>
    </section>

    <section class="card" id="quoteCard" aria-live="polite">
      <div class="quote-header">
        <h2 id="quoteTitle">Quotation summary</h2>
      </div>
      <div id="quoteBody" hidden>
        <div class="quote-summary">
          <div class="item"><span>Storage</span><span class="value" id="outStorage">HKD 0</span></div>
          <div class="item"><span>Inbound handling</span><span class="value" id="outInbound">HKD 0</span></div>
          <div class="item"><span>Order processing</span><span class="value" id="outOrders">HKD 0</span></div>
          <div class="item"><span>HKTVmall management</span><span class="value" id="outHKTV">HKD 0</span></div>
          <div class="item highlight"><span>Estimated monthly total</span><span class="value" id="outMonthly">HKD 0</span></div>
          <div class="item"><span>Integration (one-time)</span><span class="value" id="outIntegration">HKD 0</span></div>
          <div class="item"><span>Refundable deposit</span><span class="value" id="outDeposit">HKD 7,000</span></div>
          <div class="item highlight"><span>First invoice (includes deposit)</span><span class="value" id="outFirstInvoice">HKD 0</span></div>
          <div class="item"><span>Normal monthly after first month</span><span class="value" id="outMonthlyAgain">HKD 0</span></div>
        </div>
        <div class="chart-wrap">
          <canvas id="costChart" width="500" height="500" aria-label="Monthly cost distribution"></canvas>
          <div class="legend" id="chartLegend"></div>
        </div>
        <div class="note">
          Storage: 15 HKD/CBM/day (minimum 600 HKD per month).<br />
          Inbound: 0.8 HKD per piece (minimum 100 pieces).<br />
          Orders: 10 HKD/order for up to 2 pieces + 1.5 HKD per extra piece.<br />
          HKTVmall management: +800 HKD/month if selected.<br />
          Integration: 2,500 HKD (one-time) if selected. Deposit: 7,000 HKD first invoice.
        </div>
      </div>
    </section>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js" crossorigin="anonymous"></script>
  <script type="module">
    const APPS_SCRIPT_ENDPOINT = 'https://script.google.com/macros/s/AKfycbwL9iJefr4yhj5comoFOKrpWoKgRQCVF2wjL97q0gv3d4rfgF9AUbbHQljCBZCVA5l9/exec';

    document.addEventListener('DOMContentLoaded', () => {
      const ui = {
        form: document.getElementById('quoteForm'),
        submit: document.getElementById('submitBtn'),
        download: document.getElementById('downloadBtn'),
        reset: document.getElementById('resetBtn'),
        status: document.getElementById('status'),
        storageSelect: document.getElementById('storageCbm'),
        inbound: document.getElementById('inboundPieces'),
        orders: document.getElementById('monthlyOrders'),
        avgPieces: document.getElementById('avgPieces'),
        hktv: document.getElementById('hktv'),
        integration: document.getElementById('integration'),
        name: document.getElementById('customerName'),
        company: document.getElementById('companyName'),
        email: document.getElementById('customerEmail'),
        ordersHint: document.getElementById('ordersHint'),
        quoteCard: document.getElementById('quoteBody'),
        quoteTitle: document.getElementById('quoteTitle'),
        totals: {
          storage: document.getElementById('outStorage'),
          inbound: document.getElementById('outInbound'),
          orders: document.getElementById('outOrders'),
          hktv: document.getElementById('outHKTV'),
          monthly: document.getElementById('outMonthly'),
          integration: document.getElementById('outIntegration'),
          deposit: document.getElementById('outDeposit'),
          firstInvoice: document.getElementById('outFirstInvoice'),
          monthlyAgain: document.getElementById('outMonthlyAgain')
        },
        chart: document.getElementById('costChart'),
        legend: document.getElementById('chartLegend'),
        exportRoot: document.getElementById('quoteCard').parentElement
      };

      const STORAGE_OPTIONS = Array.from({ length: 30 }, (_, idx) => ({
        value: idx + 1,
        label: idx === 0
          ? 'Storage (1 CBM or below)'
          : `Storage (over ${idx} CBM to ${idx + 1} CBM)`
      }));
      const ORDER_MIN_BY_TIER = STORAGE_OPTIONS.map((_, idx) => (idx + 1) * 100);

      STORAGE_OPTIONS.forEach(opt => {
        const option = document.createElement('option');
        option.value = String(opt.value);
        option.textContent = opt.label;
        ui.storageSelect.appendChild(option);
      });
      ui.storageSelect.value = '1';

      const ctx = ui.chart.getContext('2d', { willReadFrequently: true });

      function currency(amount) {
        return `HKD ${Math.round(amount).toLocaleString()}`;
      }

      function updateOrderMinimum() {
        const tierIndex = Math.max(0, Math.min(ORDER_MIN_BY_TIER.length - 1, Number(ui.storageSelect.value) - 1));
        const minOrders = ORDER_MIN_BY_TIER[tierIndex];
        ui.ordersHint.textContent = `Minimum orders for this storage tier: ${minOrders} per month.`;
        if ((Number(ui.orders.value) || 0) < minOrders) {
          ui.orders.value = String(minOrders);
        }
      }

      function computeQuote() {
        const storageTier = Number(ui.storageSelect.value) || 1;
        const storageDays = 30;
        const tierIndex = storageTier - 1;
        const minOrders = ORDER_MIN_BY_TIER[tierIndex];

        const inboundPieces = Math.max(100, Number(ui.inbound.value) || 0);
        const orders = Math.max(minOrders, Number(ui.orders.value) || 0);
        const avgPieces = Math.max(1, Number(ui.avgPieces.value) || 1);

        const storageCost = Math.max(600, storageTier * 15 * storageDays);
        const inboundCost = inboundPieces * 0.8;
        const extrasPerOrder = Math.max(0, avgPieces - 2);
        const orderCost = orders * (10 + extrasPerOrder * 1.5);
        const hktvCost = ui.hktv.value === 'yes' ? 800 : 0;

        const integration = ui.integration.value === 'yes' ? 2500 : 0;
        const deposit = 7000;

        const monthlyTotal = storageCost + inboundCost + orderCost + hktvCost;
        const firstInvoice = monthlyTotal + integration + deposit;

        return {
          storageCost,
          inboundCost,
          orderCost,
          hktvCost,
          monthlyTotal,
          integration,
          deposit,
          firstInvoice,
          monthlyAgain: monthlyTotal
        };
      }

      function drawChart(values) {
        const total = values.reduce((sum, val) => sum + val, 0);
        ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);

        if (!total) {
          ctx.fillStyle = '#efefef';
          ctx.beginPath();
          ctx.arc(250, 250, 200, 0, Math.PI * 2);
          ctx.fill();
          return;
        }

        const colors = [
          '#ffb703',
          '#ff9f1c',
          '#fb8500',
          '#ffd166'
        ];
        let startAngle = -Math.PI / 2;

        values.forEach((val, idx) => {
          const sliceAngle = (val / total) * Math.PI * 2;
          ctx.beginPath();
          ctx.moveTo(250, 250);
          ctx.arc(250, 250, 200, startAngle, startAngle + sliceAngle);
          ctx.closePath();
          ctx.fillStyle = colors[idx % colors.length];
          ctx.fill();
          startAngle += sliceAngle;
        });

        ctx.fillStyle = '#ffffff';
        ctx.beginPath();
        ctx.arc(250, 250, 110, 0, Math.PI * 2);
        ctx.fill();

        ctx.fillStyle = '#1f1f2b';
        ctx.textAlign = 'center';
        ctx.font = '700 20px Inter, sans-serif';
        ctx.fillText(currency(total), 250, 235);
        ctx.font = '600 12px Inter, sans-serif';
        ctx.fillStyle = '#6b7280';
        ctx.fillText('Estimated monthly total', 250, 260);
      }

      function renderLegend(values) {
        const labels = ['Storage', 'Inbound', 'Orders', 'HKTVmall'];
        const total = values.reduce((sum, val) => sum + val, 0) || 1;
        const colors = ['#ffb703', '#ff9f1c', '#fb8500', '#ffd166'];
        ui.legend.innerHTML = '';

        labels.forEach((label, idx) => {
          const chip = document.createElement('div');
          chip.className = 'chip';
          const swatch = document.createElement('span');
          swatch.style.background = colors[idx % colors.length];
          chip.appendChild(swatch);
          chip.appendChild(document.createTextNode(`${label}: ${currency(values[idx])} Â· ${(values[idx] / total * 100).toFixed(1)}%`));
          ui.legend.appendChild(chip);
        });
      }

      function updateQuote() {
        const result = computeQuote();
        ui.totals.storage.textContent = currency(result.storageCost);
        ui.totals.inbound.textContent = currency(result.inboundCost);
        ui.totals.orders.textContent = currency(result.orderCost);
        ui.totals.hktv.textContent = currency(result.hktvCost);
        ui.totals.monthly.textContent = currency(result.monthlyTotal);
        ui.totals.integration.textContent = currency(result.integration);
        ui.totals.deposit.textContent = currency(result.deposit);
        ui.totals.firstInvoice.textContent = currency(result.firstInvoice);
        ui.totals.monthlyAgain.textContent = currency(result.monthlyAgain);

        const companyName = ui.company.value.trim();
        ui.quoteTitle.textContent = companyName
          ? `Quotation for ${companyName}`
          : 'Quotation summary';
        ui.quoteCard.hidden = false;

        const chartValues = [
          result.storageCost,
          result.inboundCost,
          result.orderCost,
          result.hktvCost
        ];
        drawChart(chartValues);
        renderLegend(chartValues);
      }

      function setStatus(type, message) {
        ui.status.className = `status ${type || ''}`;
        ui.status.textContent = message || '';
      }

async function generatePdfBlob() {
  await new Promise(resolve => requestAnimationFrame(resolve));

  // Render at a lower resolution straight from html2canvas
  const screenshot = await html2canvas(ui.exportRoot, {
    backgroundColor: '#ffffff',
    scale: 0.75,      // less pixels than 1.0
    useCORS: true
  });

  // Downscale the screenshot even further before converting to JPEG
  const shrinkFactor = 0.7; // 70% of the rendered size
  const helper = document.createElement('canvas');
  helper.width  = Math.floor(screenshot.width  * shrinkFactor);
  helper.height = Math.floor(screenshot.height * shrinkFactor);

  const helperCtx = helper.getContext('2d', { willReadFrequently: true });
  helperCtx.drawImage(screenshot, 0, 0, helper.width, helper.height);

  const jpegDataUrl = helper.toDataURL('image/jpeg', 0.65); // more aggressive compression

  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF({ orientation: 'portrait', unit: 'pt', format: 'a4' });

  const pageWidth  = pdf.internal.pageSize.getWidth();
  const pageHeight = pdf.internal.pageSize.getHeight();
  const ratio      = Math.min(pageWidth / helper.width, pageHeight / helper.height);
  const w          = helper.width * ratio;
  const h          = helper.height * ratio;
  const x          = (pageWidth - w) / 2;
  const y          = (pageHeight - h) / 2;

  pdf.addImage(jpegDataUrl, 'JPEG', x, y, w, h);

  return pdf.output('blob');
}
      async function submitHandler(event) {
        event.preventDefault();

        const invalid = [...ui.form.elements].some(el => el.required && !el.value.trim());
        if (invalid) {
          setStatus('err', 'Please fill in all required fields.');
          return;
        }

        setStatus('ok', 'Calculating...');
        updateQuote();

        ui.submit.disabled = true;
        ui.reset.disabled = true;
        ui.download.disabled = true;

        try {
          setStatus('ok', 'Generating PDFâ€¦');
          const pdfBlob = await generatePdfBlob();
          console.log('PDF size (bytes):', pdfBlob.size);

          const quote = computeQuote();
          const payload = new FormData();
          const filename = `eplus-quotation-${Date.now()}.pdf`;

          payload.append('file', pdfBlob, filename);
          payload.append('filename', filename);
          payload.append('generated_at', new Date().toISOString());
          payload.append('customer_name', ui.name.value.trim());
          payload.append('company_name', ui.company.value.trim());
          payload.append('customer_email', ui.email.value.trim());
          payload.append('storage_cbm', ui.storageSelect.value);
          payload.append('monthly_inbound', ui.inbound.value);
          payload.append('monthly_outbound', ui.orders.value);
          payload.append('avg_pieces_per_order', ui.avgPieces.value);
          payload.append('hktv', ui.hktv.value);
          payload.append('system_integration', ui.integration.value);
          payload.append('calc_storage', quote.storageCost);
          payload.append('calc_inbound_handling', quote.inboundCost);
          payload.append('calc_order_processing', quote.orderCost);
          payload.append('calc_hktv_fee', quote.hktvCost);
          payload.append('calc_monthly_total', quote.monthlyTotal);
          payload.append('calc_integration_setup', quote.integration);
          payload.append('calc_deposit', quote.deposit);
          payload.append('calc_first_month_total', quote.firstInvoice);
          payload.append('calc_monthly_again', quote.monthlyAgain);

          setStatus('ok', 'Uploading via Hookdeckâ€¦');
          const response = await fetch(HOOKDECK_ENDPOINT, {
            method: 'POST',
            body: payload
          });

          const raw = await response.text();
          console.log('Server raw response:', response.status, raw);

          let data;
          try { data = JSON.parse(raw); } catch (_) {}

          if (!response.ok || !data || data.ok !== true) {
            throw new Error(data && data.error ? data.error : `Upload failed (HTTP ${response.status})`);
          }

          setStatus('ok', 'Saved successfully. PDF link stored in Google Sheet.');
          ui.download.disabled = false;
        } catch (error) {
          console.error(error);
          setStatus('err', error.message || 'Submission failed.');
        } finally {
          ui.submit.disabled = false;
          ui.reset.disabled = false;
        }
      }

      async function downloadHandler() {
        try {
          const pdfBlob = await generatePdfBlob();
          const pdfUrl = URL.createObjectURL(pdfBlob);
          const a = document.createElement('a');
          a.href = pdfUrl;
          a.download = `eplus-quotation-${Date.now()}.pdf`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(pdfUrl);
        } catch (error) {
          console.error(error);
          setStatus('err', 'PDF download failed.');
        }
      }

      function resetForm() {
        ui.form.reset();
        ui.storageSelect.value = '1';
        ui.inbound.value = '100';
        ui.orders.value = '100';
        ui.avgPieces.value = '2';
        ui.hktv.value = 'no';
        ui.integration.value = 'no';
        ui.quoteCard.hidden = true;
        setStatus('', '');
        updateOrderMinimum();
      }

      ui.storageSelect.addEventListener('change', () => {
        updateOrderMinimum();
        updateQuote();
      });
      [ui.inbound, ui.orders, ui.avgPieces, ui.hktv, ui.integration, ui.name, ui.company].forEach(input => {
        input.addEventListener('input', () => {
          updateOrderMinimum();
          updateQuote();
        });
      });

      ui.form.addEventListener('submit', submitHandler);
      ui.reset.addEventListener('click', resetForm);
      ui.download.addEventListener('click', downloadHandler);

      updateOrderMinimum();
      updateQuote();
    });
  </script>
</body>
</html>
