<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>e+solutions Pricing Calculator</title>
  <style>
    :root { color-scheme: light dark; }
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin:0; padding:16px; line-height:1.45; }
    .container { max-width: 880px; margin: 0 auto; }
    h1 { margin: 0 0 8px; font-size: 1.6rem; }
    p.lead { margin: 0 0 16px; color: #555; }
    .grid { display: grid; grid-template-columns: 1fr; gap: 12px; }
    @media (min-width: 720px) { .grid { grid-template-columns: 1fr 1fr; } }
    label { display:block; font-weight:600; margin-bottom:6px; }
    input, select, button, a.button { width:100%; font-size:16px; padding:10px; box-sizing:border-box; }
    .actions { display:flex; gap:10px; margin-top:12px; flex-wrap:wrap; }
    button, a.button { background:#0a7a3f; color:#fff; border:none; border-radius:8px; cursor:pointer; text-decoration:none; text-align:center; }
    button.secondary, a.secondary { background:#666; }
    button:disabled { opacity:.6; cursor:not-allowed; }
    .quote { margin-top:20px; border:1px solid #e3e3e3; border-radius:10px; padding:16px; background: #fafafa; }
    .row { display:flex; justify-content:space-between; padding:6px 0; border-bottom:1px dashed #ddd; }
    .row:last-child { border-bottom:0; }
    .muted { color:#666; font-size:14px; }
    .ok { color:#0a7a3f; }
    .err { color:#b00020; }
    .note { margin-top: 10px; font-size: 13px; color: #444; }
    .totals { font-weight:700; }
  </style>
</head>
<body>
  <div class="container">
    <h1>e+solutions Pricing Calculator</h1>
    <p class="lead">Click Submit to calculate, generate a PDF, and save everything (including the PDF link) to your sheet.</p>

    <div class="grid">
      <div>
        <label for="customerName">Name</label>
        <input id="customerName" placeholder="Required" />
      </div>
      <div>
        <label for="companyName">Company name</label>
        <input id="companyName" placeholder="Required" />
      </div>
      <div>
        <label for="customerEmail">Customer Email</label>
        <input id="customerEmail" placeholder="Required" />
      </div>
      <div>
        <label for="storageCbm">Storage in CBM</label>
        <select id="storageCbm">
          <option value="0">0</option>
          <option value="1">1</option>
          <option value="5">5</option>
          <option value="10">10</option>
          <option value="20">20</option>
          <option value="50">50</option>
          <option value="100">100</option>
        </select>
      </div>
      <div>
        <label for="inboundPieces">Monthly Inbound Pieces</label>
        <input id="inboundPieces" type="number" min="0" inputmode="numeric" />
      </div>
      <div>
        <label for="monthlyOrders">Monthly Orders (Outbound)</label>
        <input id="monthlyOrders" type="number" min="0" inputmode="numeric" />
        <div class="muted">Minimum required based on your storage tier: 100 orders/month.</div>
      </div>
      <div>
        <label for="avgPieces">Average Pieces per Order</label>
        <input id="avgPieces" type="number" min="1" inputmode="numeric" />
      </div>
      <div>
        <label for="hktv">HKTVmall management?</label>
        <select id="hktv">
          <option value="No">No</option>
          <option value="Yes">Yes</option>
        </select>
      </div>
      <div>
        <label for="integration">System Integration?</label>
        <select id="integration">
          <option value="No">No</option>
          <option value="Yes">Yes</option>
        </select>
      </div>
    </div>

    <div class="actions">
      <button id="submitBtn">Submit</button>
      <button id="clearBtn" class="secondary" type="button">Clear</button>
      <a id="downloadPdf" class="button" href="#" download="quotation.pdf" style="display:none">Download PDF</a>
    </div>

    <div id="status" class="muted" role="status" aria-live="polite"></div>

    <div id="quote" class="quote">
      <div class="row"><div>Storage</div><div id="outStorage">HKD 0</div></div>
      <div class="row"><div>Inbound Handling</div><div id="outInbound">HKD 0</div></div>
      <div class="row"><div>Order Processing</div><div id="outOrders">HKD 0</div></div>
      <div class="row"><div>HKTVmall management fee (if any)</div><div id="outHktv">HKD 0</div></div>
      <div class="row totals"><div>Estimated Monthly Total</div><div id="outMonthly">HKD 0</div></div>
      <div class="row"><div>One-time System Integration</div><div id="outIntegration">HKD 0</div></div>
      <div class="row"><div>Refundable Deposit</div><div>HKD 7,000</div></div>
      <div class="row totals"><div>Setup + First Month (includes refundable deposit)</div><div id="outSetupFirst">HKD 0</div></div>
      <div class="row totals"><div>Normal Monthly Cost After First Month</div><div id="outNormalMonthly">HKD 0</div></div>
    </div>

    <div class="note">
      <strong>How we calculate our prices</strong>
      <ul>
        <li>Storage: 15 HKD per CBM per day, billed up to 30 days/month; minimum 600 HKD/month.</li>
        <li>Inbound: 0.8 HKD per piece (we calculate with 100 pieces if you enter less).</li>
        <li>Order processing: 10 HKD per order including up to 2 pieces; +1.5 HKD for each additional piece.</li>
        <li>HKTVmall management fee: +800 HKD/month if selected.</li>
        <li>System Integration (first-time customers): 2,500 HKD one-time; refundable deposit: 7,000 HKD on first invoice.</li>
        <li>Monthly Orders minimum updates automatically based on your Storage CBM.</li>
        <li>Estimates for planning; final billing depends on actual usage.</li>
      </ul>
    </div>
  </div>

  <script>
    // Your Apps Script Web App URL (exec)
    const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbzZF_RjZRsuPow8CbFzShbPmPopddQpAOAS_MbxNHN0au2Xvv6NxK5QOFqmcCfp6NWO/exec';

    // Safe getters
    function getVal(sel){ return (document.querySelector(sel)?.value ?? '').toString().trim(); }
    function getNum(sel){ const v = getVal(sel); const n = Number((v || '').replace(/,/g,'')); return Number.isFinite(n) ? n : 0; }
    function formatHKD(n){ return 'HKD ' + (Math.round(Number(n) || 0)).toLocaleString('en-HK'); }

    function calc() {
      const storageCbm = getNum('#storageCbm');
      const inboundPieces = Math.max(100, getNum('#inboundPieces'));
      const monthlyOrders = Math.max(100, getNum('#monthlyOrders'));
      const avgPieces = Math.max(1, getNum('#avgPieces'));
      const hktvmall = getVal('#hktv') === 'Yes';
      const integration = getVal('#integration') === 'Yes';

      const storage = Math.max(600, 15 * storageCbm * 30);
      const inbound = 0.8 * inboundPieces;
      const baseOrder = 10 * monthlyOrders;
      const extraPieces = Math.max(0, avgPieces - 2) * 1.5 * monthlyOrders;
      const orderProcessing = baseOrder + extraPieces;
      const hktvFee = hktvmall ? 800 : 0;

      const monthlyTotal = storage + inbound + orderProcessing + hktvFee;
      const integrationOneTime = integration ? 2500 : 0;
      const refundableDeposit = 7000;
      const setupFirst = monthlyTotal + integrationOneTime + refundableDeposit;
      const normalMonthly = monthlyTotal;

      // Update UI
      document.getElementById('outStorage').textContent = formatHKD(storage);
      document.getElementById('outInbound').textContent = formatHKD(inbound);
      document.getElementById('outOrders').textContent = formatHKD(orderProcessing);
      document.getElementById('outHktv').textContent = formatHKD(hktvFee);
      document.getElementById('outMonthly').textContent = formatHKD(monthlyTotal);
      document.getElementById('outIntegration').textContent = formatHKD(integrationOneTime);
      document.getElementById('outSetupFirst').textContent = formatHKD(setupFirst);
      document.getElementById('outNormalMonthly').textContent = formatHKD(normalMonthly);

      return { storage, inbound, orderProcessing, hktvFee, monthlyTotal, integrationOneTime, refundableDeposit, setupFirst, normalMonthly };
    }

    async function handleSubmit() {
      try {
        document.getElementById('status').className = 'muted';
        document.getElementById('status').textContent = 'Calculating...';
        const fig = calc();

        // Read inputs
        const name = getVal('#customerName');
        const company = getVal('#companyName');
        const email = getVal('#customerEmail');
        const storageCbm = getNum('#storageCbm');
        const inboundPieces = getNum('#inboundPieces');
        const monthlyOrders = getNum('#monthlyOrders');
        const avgPieces = getNum('#avgPieces');
        const hktv = getVal('#hktv') || 'No';
        const integration = getVal('#integration') || 'No';

        // Minimal client-side validation
        if (!name || !company || !email) {
          document.getElementById('status').textContent = 'Please fill in Name, Company, and Email.';
          document.getElementById('status').className = 'err';
          return;
        }

        // Build FormData â€” do NOT set Content-Type
        const fd = new FormData();
        fd.append('customerName', name);
        fd.append('companyName', company);
        fd.append('customerEmail', email);
        fd.append('storageCbm', String(storageCbm));
        fd.append('inboundPieces', String(inboundPieces));
        fd.append('monthlyOrders', String(monthlyOrders));
        fd.append('avgPieces', String(avgPieces));
        fd.append('hktv', hktv);
        fd.append('integration', integration);

        // Append calculated outputs (optional)
        Object.entries(fig).forEach(([k,v]) => fd.append(k, String(Math.round(v))));

        document.getElementById('status').textContent = 'Submitting to server...';
        document.getElementById('submitBtn').disabled = true;

        const res = await fetch(WEB_APP_URL, { method: 'POST', body: fd });
        const text = await res.text();
        console.log('Server raw response:', res.status, text);

        let data;
        try { data = JSON.parse(text); } catch(e) { data = { ok:false, raw:text }; }

        if (res.ok && data && data.ok) {
          document.getElementById('status').textContent = 'Saved successfully.' + (data.fileUrl ? ' PDF uploaded.' : '');
          document.getElementById('status').className = 'ok';
          if (data.fileUrl) {
            const a = document.getElementById('downloadPdf');
            a.href = data.fileUrl;
            a.style.display = 'inline-block';
          }
        } else {
          document.getElementById('status').textContent = 'Failed to save: ' + (data.error || text);
          document.getElementById('status').className = 'err';
        }
      } catch (err) {
        console.error(err);
        document.getElementById('status').textContent = 'Error: ' + (err?.message || err);
        document.getElementById('status').className = 'err';
      } finally {
        document.getElementById('submitBtn').disabled = false;
      }
    }

    function handleClear() {
      ['#customerName','#companyName','#customerEmail','#inboundPieces','#monthlyOrders','#avgPieces'].forEach(sel => {
        const el = document.querySelector(sel);
        if (el) el.value = '';
      });
      document.getElementById('storageCbm').value = '0';
      document.getElementById('hktv').value = 'No';
      document.getElementById('integration').value = 'No';
      document.getElementById('status').textContent = '';
      document.getElementById('status').className = 'muted';
      document.getElementById('downloadPdf').style.display = 'none';
      calc();
    }

    document.getElementById('submitBtn').addEventListener('click', handleSubmit);
    document.getElementById('clearBtn').addEventListener('click', handleClear);

    // Auto recalc
    ['#storageCbm','#inboundPieces','#monthlyOrders','#avgPieces','#hktv','#integration']
      .forEach(sel => document.querySelector(sel).addEventListener('input', calc));

    // First calculation
    calc();
  </script>
</body>
</html>
